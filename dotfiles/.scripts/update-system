#!/usr/bin/env bash

set -euo pipefail

# --- Configuration ---
FLAKE_PATH="$HOME/.nix"
ORIGINAL_DIR=$(pwd) # Used in sudo trap command below
ZINIT_HOME="${HOME}/.local/share/zinit/zinit.git"
ACTUAL_USER=${SUDO_USER:-$USER}
USER_HOME=$(getent passwd "$ACTUAL_USER" | cut -d: -f6)

# Source the zinit script so the 'zinit' command is available
if [ -f "$ZINIT_HOME/zinit.zsh" ]; then
    source "$ZINIT_HOME/zinit.zsh"
else
    echo "Zinit not found at $ZINIT_HOME"
    exit 1
fi

# --- Helper Functions ---

# Check if a command exists
cmd_exists() { command -v "$1" >/dev/null 2>&1; }

# Keep sudo timestamp updated while the script runs
keep_sudo_alive() {
  # Update the timestamp immediately
  sudo -v

  # Run a background loop to refresh the timestamp every 60 seconds
  while true; do
    sudo -n true
    sleep 60
    # Exit the loop if the parent script finishes
    kill -0 "$$" || exit
  done 2>/dev/null &
}

# Clear credentials on exit
clear_sudo() {
  sudo -k
}

# Stop if there are uncommitted manual changes
check_git_status() {
  if [ ! -d "$FLAKE_PATH/.git" ]; then return 0; fi
  cd "$FLAKE_PATH"
  if ! git diff-index --quiet HEAD --; then
    echo "--------------------------------------------------------"
    echo "[!] ERROR: Uncommitted changes detected in $FLAKE_PATH"
    echo "    Please commit or stash your manual edits first."
    echo "--------------------------------------------------------"
    exit 1
  fi
}

# Sync with remote before making any changes
git_sync_remote() {
  if [ ! -d "$FLAKE_PATH/.git" ]; then return 0; fi
  cd "$FLAKE_PATH"
  echo "Syncing with remote repository..."
  git fetch origin
  # Rebase to keep a clean, linear history
  git rebase origin/$(git branch --show-current)
  echo "[✓] Git sync complete"
}

# Update the flake.lock
update_flake() {
  if ! cmd_exists nix; then
    echo "nix not found; skipping flake update."
    return 1
  fi
  echo "Updating flake at $FLAKE_PATH..."
  cd "$FLAKE_PATH"
  if nix flake update; then
    echo "[✓] Flake updated"
  else
    echo "[!] Failed to update flake"
    return 1
  fi
}

# Commit and Push ONLY if flake.lock changed
git_commit_push() {
  if [ ! -d "$FLAKE_PATH/.git" ]; then return 0; fi
  cd "$FLAKE_PATH"

  if git diff --exit-code flake.lock >/dev/null; then
    echo "[-] No changes detected in flake.lock. Skipping push."
    return 0
  fi

  echo "Changes detected. Committing and pushing..."
  git add flake.lock
  git commit -m "Nix flake update [$(date +'%Y-%m-%d %H:%M:%S')]"
  git push
  echo "[✓] Changes pushed to remote"
}

# Nix home-manager rebuild
rebuild_home() {
  echo "Rebuilding Home Manager..."
  if ! home-manager switch -b backup --flake "$FLAKE_PATH"; then
    echo "[!] home-manager switch failed"
    return 1
  fi
  echo "[✓] Home Manager switch succeeded"
}

# Run Nix Garbage Collection
gc_nix() {
  echo "Running Nix garbage collection (older than 14d)..."
  sudo nix-collect-garbage --delete-older-than 14d
}

# --- Main Execution ---

if [ "$(id -u)" -eq 0 ]; then
  echo "Please run this script as your regular user (not as root)."
  exit 1
fi

# Start sudo loop
echo "This script requires sudo for system updates. Please authenticate:"
keep_sudo_alive
SUDO_LOOP_PID=$! # Capture the PID of the background loop

# This ensures that if the script exits (normally or by error),
# we kill the background loop and clear the sudo timestamp.
trap 'kill "$SUDO_LOOP_PID" 2>/dev/null; sudo -k; cd "$ORIGINAL_DIR"; echo "Cleaned up sudo and returned to $ORIGINAL_DIR"' EXIT

OS_ID=""
if [ -f /etc/os-release ]; then
  . /etc/os-release
  OS_ID="${ID:-}"
fi

echo "Detected OS: $OS_ID"
echo "---------------------------------------"

# Step 1: Safety Checks & Sync
check_git_status
git_sync_remote

# Step 2: Update Flake & Share
update_flake || true
git_commit_push || true

# Step 3: Apply System Changes
case "$OS_ID" in
  nixos)
    echo "Applying NixOS System Rebuild..."
    if sudo nixos-rebuild switch --flake "$FLAKE_PATH"; then
      echo "[✓] nixos-rebuild succeeded"
    else
      echo "[!] nixos-rebuild failed"
      exit 1
    fi
    rebuild_home || true
    gc_nix || true
    zinit self-update
    zinit update
    ;;

  fedora)
    echo "Applying Fedora DNF Upgrade..."
    sudo dnf upgrade --refresh -y

    echo "Updating Zsh Zinit and it's Plugins..."
sudo -u "$ACTUAL_USER" zsh <<-EOF
    source "$USER_HOME/.local/share/zinit/zinit.git/zinit.zsh"
    zinit self-update
    zinit update
EOF

    rebuild_home || true
    if cmd_exists nix; then gc_nix || true; fi
    ;;

  *)
    echo "Unsupported OS. Attempting Home Manager rebuild only..."
    rebuild_home || true
    ;;
esac

echo "---------------------------------------"
echo "Done."
